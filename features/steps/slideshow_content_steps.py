from behave import *
from hamcrest import assert_that, calling, is_, raises
from selenium.common.exceptions import NoSuchElementException
from selenium.webdriver.support.ui import Select
import requests
from time import sleep
from radiator import source_types
from image_sources.slideshow import SlideshowContent


@given('a slideshow source exists')
def step_impl(context):
    requests.post(context.url + '/source', json={
        'index': source_types.index(SlideshowContent),
        'config': {
            'name': 'test slideshow content'
        }
    })


@when('I set two image URLs')
def step_impl(context):
    sleep(0.1)  # This is needed for the config to show up in the DOM
                # TODO: Change this to an eventually style test
    image_urls_field = context.browser.find_element_by_name('images')
    image_urls_field.clear()
    image_urls_field.send_keys(f'{context.url}/white.png\n{context.url}/red.png')


@when('I change the interval to 1 second')
def step_impl(context):
    interval_field = context.browser.find_element_by_name('interval')
    interval_field.clear()
    interval_field.send_keys('1')


@when('I select the slideshow source')
def step_impl(context):
    source_selection = Select(context.browser.find_element_by_id('image_sources'))
    source_selection.select_by_visible_text('test slideshow content')


@when('I wait for 1.5 seconds')
def step_impl(context):
    sleep(1.5)


first_image = 'url("data:image/png;base64,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")'
second_image = 'url("data:image/png;base64,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")'


@then('the screen shows the first image')
def step_impl(context):
    sleep(0.1)
    preview_image = context.browser.find_element_by_id('preview-image')
    image = preview_image.value_of_css_property('background-image')
    assert_that(image, is_(first_image))


@then('the screen image shows the second image')
def step_impl(context):
    sleep(0.1)
    preview_image = context.browser.find_element_by_id('preview-image')
    image = preview_image.value_of_css_property('background-image')
    assert_that(image, is_(second_image))

